<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trendy SMM - Grow Fast</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #0f172a;
            --surface: #1e293b;
            --primary: #6366f1; /* Indigo */
            --primary-glow: rgba(99, 102, 241, 0.4);
            --accent: #10b981;
            --danger: #ef4444;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: #334155;
            --font: 'Plus Jakarta Sans', sans-serif;
        }

        body { margin: 0; font-family: var(--font); background: var(--bg-dark); color: var(--text-main); -webkit-font-smoothing: antialiased; }
        
        /* ========================
           1. MODERN AUTH LAYOUT
           ======================== */
        #auth-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            min-height: 100vh;
            width: 100%;
        }

        /* Left Side: Marketing/Hero */
        .auth-hero {
            background: linear-gradient(135deg, #312e81 0%, #0f172a 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 60px;
            position: relative;
            overflow: hidden;
        }
        
        .auth-hero::before {
            content: ''; position: absolute; top: -10%; right: -10%;
            width: 400px; height: 400px; background: var(--primary);
            filter: blur(150px); opacity: 0.2; border-radius: 50%;
        }
        .auth-hero::after {
            content: ''; position: absolute; bottom: -10%; left: -10%;
            width: 300px; height: 300px; background: var(--accent);
            filter: blur(120px); opacity: 0.1; border-radius: 50%;
        }

        .hero-content { position: relative; z-index: 2; max-width: 500px; }
        .hero-brand { font-size: 14px; font-weight: 700; letter-spacing: 2px; color: var(--accent); text-transform: uppercase; margin-bottom: 20px; display: inline-block; background: rgba(16, 185, 129, 0.1); padding: 8px 16px; border-radius: 30px; border: 1px solid rgba(16, 185, 129, 0.2); }
        .hero-title { font-size: 48px; line-height: 1.1; font-weight: 800; margin-bottom: 20px; background: linear-gradient(to right, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .hero-desc { font-size: 18px; color: var(--text-muted); line-height: 1.6; margin-bottom: 40px; }
        
        .feature-list { list-style: none; padding: 0; }
        .feature-list li { margin-bottom: 15px; display: flex; align-items: center; gap: 10px; font-weight: 500; font-size: 16px; }
        .feature-icon { color: var(--accent); background: rgba(16, 185, 129, 0.1); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        /* Right Side: Form */
        .auth-form-wrapper {
            display: flex; align-items: center; justify-content: center;
            background: var(--bg-dark); padding: 40px;
        }
        .auth-box { width: 100%; max-width: 420px; }
        
        .form-header { margin-bottom: 30px; }
        .form-header h2 { font-size: 28px; margin: 0 0 8px 0; }
        .form-header p { color: var(--text-muted); margin: 0; }

        /* Inputs */
        .input-group { margin-bottom: 16px; }
        .input-label { display: block; font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; }
        .input-field { 
            width: 100%; padding: 14px 16px; 
            background: var(--surface); border: 1px solid var(--border); 
            color: white; border-radius: 8px; font-size: 15px; 
            font-family: inherit; transition: 0.2s; box-sizing: border-box;
        }
        .input-field:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 4px var(--primary-glow); background: #253045; }

        .signup-fields { display: none; }

        .btn-primary {
            width: 100%; padding: 16px; margin-top: 10px;
            background: var(--primary); color: white; border: none; 
            border-radius: 8px; font-size: 16px; font-weight: 700; 
            cursor: pointer; transition: 0.2s; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        .btn-primary:hover { background: #4f46e5; transform: translateY(-2px); }
        .btn-primary:active { transform: translateY(0); }

        .switch-text { text-align: center; margin-top: 25px; color: var(--text-muted); font-size: 14px; }
        .switch-link { color: var(--primary); font-weight: 700; cursor: pointer; text-decoration: none; margin-left: 5px; }
        .switch-link:hover { text-decoration: underline; }

        @media (max-width: 900px) {
            #auth-container { grid-template-columns: 1fr; }
            .auth-hero { display: none; }
            .auth-form-wrapper { padding: 20px; min-height: 100vh; align-items: center; }
        }

        /* ========================
           2. DASHBOARD STYLES
           ======================== */
        #dashboard-container { display: none; max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        .navbar { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 16px 24px; background: var(--surface); 
            border-radius: 16px; border: 1px solid var(--border); margin-bottom: 30px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        .logo { font-weight: 800; font-size: 22px; letter-spacing: -0.5px; color: white; display:flex; align-items:center; gap:10px; }
        .logo span { color: var(--primary); }
        
        /* Desktop Menu (User Pill) */
        .user-pill { 
            background: #253045; border: 1px solid var(--border);
            padding: 8px 16px; border-radius: 30px; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 12px;
        }

        /* Mobile Hamburger & Menu */
        .hamburger { display: none; font-size: 24px; cursor: pointer; color: white; }
        .mobile-menu {
            display: none;
            position: absolute; top: 100%; left: 0; right: 0;
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 10px; margin-top: 10px; padding: 15px;
            z-index: 100; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            flex-direction: column; gap: 15px; text-align: center;
        }
        .mobile-menu.active { display: flex; }

        .grid-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--surface); padding: 25px; border-radius: 16px; border: 1px solid var(--border); position: relative; overflow: hidden; }
        .stat-card h3 { margin: 0 0 5px 0; font-size: 28px; color: white; }
        .stat-card p { margin: 0; color: var(--text-muted); font-size: 13px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
        .stat-shine { position: absolute; top:0; right:0; width:100px; height:100px; background:radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 70%); }

        .main-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
        @media(max-width: 850px) { 
            .main-layout { grid-template-columns: 1fr; } 
            /* Hide Desktop Pill, Show Hamburger */
            .user-pill { display: none; }
            .hamburger { display: block; }
        }

        .panel-card { background: var(--surface); padding: 30px; border-radius: 20px; border: 1px solid var(--border); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .card-head { font-size: 18px; font-weight: 700; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; padding-bottom: 15px; border-bottom: 1px solid var(--border); }
        
        select, input { width: 100%; padding: 14px; background: #0f172a; border: 1px solid var(--border); color: white; border-radius: 10px; font-size: 14px; box-sizing: border-box; font-family: var(--font); margin-top:5px; }
        select:focus, input:focus { border-color: var(--primary); outline: none; }
        label { color: var(--text-muted); font-size: 13px; font-weight: 600; margin-top: 15px; display: block; }
        
        .dash-btn { width: 100%; background: var(--primary); color: white; border:none; padding: 15px; border-radius: 10px; font-weight: 700; margin-top: 20px; cursor: pointer; }
        .dash-btn:hover { background: #4f46e5; }

        /* Scrollable Table Wrapper */
        .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px; min-width: 500px; }
        th { text-align: left; padding: 15px; color: var(--text-muted); font-weight: 600; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.2); }
        td { padding: 15px; border-bottom: 1px solid var(--border); color: var(--text-main); }
        .badge { padding: 5px 10px; border-radius: 6px; font-size: 11px; font-weight: 800; text-transform: uppercase; }
        .st-pending { background: rgba(245, 158, 11, 0.15); color: #fbbf24; }
        .st-completed { background: rgba(16, 185, 129, 0.15); color: #34d399; }
        .st-canceled { background: rgba(239, 68, 68, 0.15); color: #f87171; }
        .st-processing { background: rgba(59, 130, 246, 0.15); color: #60a5fa; }
        
        .clickable-id { color: var(--primary); cursor: pointer; text-decoration: underline; font-weight: bold; }
        .clickable-id:hover { color: white; }

        /* ========================
           3. MODAL & WALLET STYLES (NEW)
           ======================== */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
        .modal-content { background-color: var(--surface); margin: 10% auto; padding: 0; border: 1px solid var(--border); width: 90%; max-width: 500px; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); animation: slideIn 0.3s ease; }
        @keyframes slideIn { from {transform: translateY(-20px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); }
        .modal-body { padding: 25px; }
        .close-modal { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-modal:hover { color: white; }

        /* Timeline */
        .timeline { display: flex; justify-content: space-between; margin-top: 20px; position: relative; }
        .timeline::before { content: ''; position: absolute; top: 15px; left: 0; right: 0; height: 2px; background: #334155; z-index: 0; }
        .tl-step { position: relative; z-index: 1; text-align: center; }
        .tl-dot { width: 30px; height: 30px; background: #1e293b; border: 2px solid #64748b; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-size: 12px; color: #64748b; font-weight: bold; transition: 0.3s; }
        .tl-text { font-size: 11px; color: #94a3b8; font-weight: 600; text-transform: uppercase; }
        
        /* Active State */
        .tl-step.active .tl-dot { border-color: var(--accent); background: var(--accent); color: black; box-shadow: 0 0 10px rgba(16, 185, 129, 0.4); }
        .tl-step.active .tl-text { color: var(--accent); }
        
        /* Wallet Ledger Items */
        .tx-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px; }
        .tx-left { display: flex; flex-direction: column; gap: 4px; }
        .tx-date { font-size: 11px; color: #64748b; }
        .tx-amount { font-weight: 700; font-size: 14px; }
        .tx-credit { color: var(--accent); } /* Green for Add Funds */
        .tx-debit { color: var(--danger); }  /* Red for Orders */

    </style>
</head>
<body>

<div id="auth-container">
    <div class="auth-hero">
        <div class="hero-content">
            <div class="hero-brand">üöÄ #1 SMM Reseller Panel</div>
            <h1 class="hero-title">Trendy SMM Panel</h1>
            <p class="hero-desc">The world's fastest growing social media marketing platform. Boost your presence, go viral, and dominate the algorithm in minutes.</p>
            
            <ul class="feature-list">
                <li><span class="feature-icon">‚ö°</span> Instant Order Delivery</li>
                <li><span class="feature-icon">üíé</span> Cheapest Rates in the Market</li>
                <li><span class="feature-icon">üõ°Ô∏è</span> Secure & Confidential</li>
                <li><span class="feature-icon">üéß</span> 24/7 Priority Support</li>
            </ul>
        </div>
    </div>

    <div class="auth-form-wrapper">
        <div class="auth-box">
            <div class="form-header">
                <h2 id="auth-head-title">Welcome Back</h2>
                <p id="auth-head-desc">Enter your credentials to access your account.</p>
            </div>

            <form id="authForm">
                <div class="signup-fields">
                    <div class="input-group">
                        <label class="input-label">Full Name</label>
                        <input type="text" id="reg-name" class="input-field" placeholder="John Doe">
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Email Address</label>
                        <input type="email" id="reg-email" class="input-field" placeholder="name@example.com">
                    </div>

                    <div class="input-group">
                        <label class="input-label">Mobile Number</label>
                        <input type="tel" id="reg-mobile" class="input-field" placeholder="+91 98765 43210">
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label">Username</label>
                    <input type="text" id="auth-username" class="input-field" placeholder="Enter username" required>
                </div>

                <div class="input-group">
                    <label class="input-label">Password</label>
                    <input type="password" id="auth-password" class="input-field" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>

                <div class="signup-fields">
                    <div class="input-group">
                        <label class="input-label">Confirm Password</label>
                        <input type="password" id="reg-confirm-pass" class="input-field" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                </div>

                <button type="submit" id="auth-btn" class="btn-primary">SECURE LOGIN</button>
            </form>

            <div class="switch-text">
                <span id="switch-msg">New to Trendy SMM?</span>
                <span class="switch-link" onclick="toggleAuthMode()">Create an Account</span>
            </div>
        </div>
    </div>
</div>

<div id="dashboard-container">
    <nav class="navbar">
        <div class="logo">‚ö° Trendy <span>SMM</span></div>
        
        <div class="user-pill">
            <span style="color:var(--accent)">‚Çπ <span id="nav-balance">0.00</span></span>
            <span style="color:#444">|</span>
            <span id="user-display">User</span>
            <button onclick="logout()" style="background:none; border:none; color:#ef4444; cursor:pointer; font-weight:bold; margin-left:5px;">&times;</button>
        </div>

        <div class="hamburger" onclick="toggleMenu()">‚ò∞</div>

        <div class="mobile-menu" id="mobileMenu">
             <div style="font-weight:bold; color:var(--text-muted);">Balance</div>
             <div style="font-size:18px; color:var(--accent);">‚Çπ <span id="mob-balance">0.00</span></div>
             <div style="border-top:1px solid var(--border); margin:5px 0;"></div>
             <div style="color:white;" id="mob-user">User</div>
             <button onclick="logout()" style="background:var(--danger); color:white; border:none; padding:10px; border-radius:8px; width:100%; font-weight:bold;">LOGOUT</button>
        </div>
    </nav>

    <div class="grid-stats">
        <div class="stat-card">
            <div class="stat-shine"></div>
            <h3 id="global-orders">...</h3>
            <p>Total Orders Delivered</p>
        </div>
        <div class="stat-card">
            <h3 id="my-balance">‚Çπ0.00</h3>
            <p>Available Balance</p>
        </div>
        <div class="stat-card">
            <h3 id="my-orders">0</h3>
            <p>My Total Orders</p>
        </div>
    </div>

    <div class="main-layout">
        <div>
            <div class="panel-card">
                <div class="card-head">üöÄ Place New Order</div>
                
                <form id="orderForm">
                    <div style="display:grid; grid-template-columns: 1fr; gap:15px;">
                         <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px;">
                            <div>
                                <label>Category</label>
                                <select id="categorySelect" onchange="filterServices()"><option>Loading...</option></select>
                            </div>
                            <div>
                                <label>Service</label>
                                <select id="serviceSelect" onchange="updateServiceInfo()"><option>Select Category First</option></select>
                            </div>
                        </div>
                    </div>

                    <div id="service-info" style="background:rgba(99,102,241,0.1); padding:15px; border-radius:10px; margin-top:15px; display:none; border:1px solid rgba(99,102,241,0.2);">
                        <div style="font-size:12px; display:flex; justify-content:space-between; color:var(--primary);">
                            <span>Min: <b id="svc-min">0</b></span>
                            <span>Max: <b id="svc-max">0</b></span>
                        </div>
                        <div style="margin-top:5px; font-weight:bold; color:white;">Rate per 1000: <span style="color:var(--accent)">‚Çπ<span id="svc-rate">0</span></span></div>
                    </div>

                    <label>Link (URL)</label>
                    <input type="text" id="link" placeholder="https://instagram.com/..." required>

                    <label>Quantity</label>
                    <input type="number" id="quantity" placeholder="e.g. 1000" oninput="calculatePrice()" required>

                    <div style="margin-top:20px; text-align:center; padding:15px; background:#1e293b; border-radius:10px; border:1px dashed #444;">
                        <span style="color:#aaa; font-size:13px;">Total Charge</span><br>
                        <span style="font-size:24px; font-weight:bold; color:white;">‚Çπ<span id="total-charge">0.00</span></span>
                    </div>

                    <button type="submit" class="dash-btn">CONFIRM ORDER</button>
                </form>
            </div>

            <div class="panel-card" style="margin-top:25px;">
                <div class="card-head">üìú Recent Orders</div>
                <div class="table-wrap">
                    <table>
                        <thead><tr><th>ID</th><th>Service</th><th>Link</th><th>Qty</th><th>Status</th></tr></thead>
                        <tbody id="history-table"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div>
            <div class="panel-card">
                <div class="card-head">üí∞ Add Funds</div>
                <div style="text-align:center; margin-bottom:20px;">
                    <img id="qr-image" src="" alt="QR" style="width:180px; border-radius:10px; border:5px solid white; display:none; margin:0 auto;">
                    <p style="font-size:12px; color:#888; margin-top:10px;">Scan QR to Pay via UPI</p>
                </div>
                
                <form id="depositForm">
                    <label>Amount (‚Çπ)</label>
                    <input type="number" id="dep-amount" placeholder="500" required>
                    
                    <label>Transaction ID (UTR)</label>
                    <input type="text" id="dep-txn" placeholder="12 digit UTR ID" required>
                    
                    <button type="submit" class="dash-btn" style="background:var(--accent); color:black;">DEPOSIT NOW</button>
                </form>

                <div style="margin-top:25px; border-top:1px solid #333; padding-top:15px;">
                    <h4 style="margin:0 0 10px 0; font-size:14px; display:flex; align-items:center; gap:5px;">
                        üí≥ Wallet Ledger <span style="font-weight:400; color:#666; font-size:11px;">(History)</span>
                    </h4>
                    <div id="wallet-history" style="max-height: 300px; overflow-y:auto; padding-right:5px;">
                        <div style="color:#aaa; font-size:12px; text-align:center; padding:10px;">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="orderModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="margin:0; color:white;">Order Details</h3>
            <span class="close-modal" onclick="closeOrderModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span style="color:#aaa;">Order ID</span>
                <span style="font-weight:bold; color:var(--primary);" id="m-order-id">#0000</span>
            </div>
            
            <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:10px; margin-bottom:20px;">
                <div style="font-size:13px; color:#aaa; margin-bottom:5px;">Service</div>
                <div style="font-weight:600; margin-bottom:10px;" id="m-service-name">Service Name</div>
                
                <div style="font-size:13px; color:#aaa; margin-bottom:5px;">Link</div>
                <div style="font-size:13px; color:var(--accent); word-break:break-all;" id="m-link">https://...</div>
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; text-align:center; margin-bottom:20px;">
                <div style="background:var(--bg-dark); padding:10px; border-radius:8px; border:1px solid var(--border);">
                    <div style="font-size:12px; color:#aaa;">Quantity</div>
                    <div style="font-weight:bold; font-size:16px;" id="m-qty">0</div>
                </div>
                <div style="background:var(--bg-dark); padding:10px; border-radius:8px; border:1px solid var(--border);">
                    <div style="font-size:12px; color:#aaa;">Charge</div>
                    <div style="font-weight:bold; font-size:16px; color:var(--accent);">‚Çπ<span id="m-price">0</span></div>
                </div>
            </div>

            <div style="display:flex; justify-content:space-between; font-size:12px; border-top:1px solid #333; padding-top:10px; margin-bottom:15px;">
                <span style="color:#64748b;">Start Count: <span id="m-start" style="color:#fff;">-</span></span>
                <span style="color:#64748b;">Remains: <span id="m-remains" style="color:#fff;">-</span></span>
            </div>

            <h4 style="margin:0 0 10px 0; font-size:14px;">Tracking Status</h4>
            <div class="timeline" id="status-timeline">
                <div class="tl-step" id="step-pending">
                    <div class="tl-dot">1</div>
                    <div class="tl-text">Pending</div>
                </div>
                <div class="tl-step" id="step-processing">
                    <div class="tl-dot">2</div>
                    <div class="tl-text">Processing</div>
                </div>
                <div class="tl-step" id="step-completed">
                    <div class="tl-dot">3</div>
                    <div class="tl-text">Completed</div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyCX5qpT_ytgJjRk21-VWZ-Ndhbq0hhjXYo",
        authDomain: "fir-integration-61a1f.firebaseapp.com",
        databaseURL: "https://fir-integration-61a1f-default-rtdb.firebaseio.com",
        projectId: "fir-integration-61a1f",
        storageBucket: "fir-integration-61a1f.firebasestorage.app",
        messagingSenderId: "178334018866",
        appId: "1:178334018866:web:ef78bc307549639d0ebb2b"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- STATE ---
    let currentUser = null;
    let services = [];
    let isLogin = true;

    // Stores for Ledger
    let myOrders = [];
    let myDeposits = [];

    // --- MOBILE MENU FUNCTION ---
    function toggleMenu() {
        const menu = document.getElementById('mobileMenu');
        if (menu.style.display === 'flex') {
            menu.style.display = 'none';
        } else {
            menu.style.display = 'flex';
        }
    }

    // --- AUTH LOGIC ---
    function checkAuth() {
        const u = localStorage.getItem('smm_user');
        if(u) { currentUser = JSON.parse(u); showDash(); } 
        else { showAuth(); }
    }
    
    function showAuth() { document.getElementById('auth-container').style.display = 'grid'; document.getElementById('dashboard-container').style.display = 'none'; }
    function showDash() { 
        document.getElementById('auth-container').style.display = 'none'; 
        document.getElementById('dashboard-container').style.display = 'block';
        
        // Update both Desktop and Mobile elements
        document.getElementById('user-display').innerText = currentUser.username;
        document.getElementById('mob-user').innerText = currentUser.username;
        
        initData();
    }
    
    function toggleAuthMode() {
        isLogin = !isLogin;
        
        // Toggle Text
        document.getElementById('auth-head-title').innerText = isLogin ? 'Welcome Back' : 'Create Account';
        document.getElementById('auth-head-desc').innerText = isLogin ? 'Enter your credentials to access.' : 'Fill the details below to get started.';
        document.getElementById('auth-btn').innerText = isLogin ? 'SECURE LOGIN' : 'REGISTER NOW';
        
        document.getElementById('switch-msg').innerText = isLogin ? 'New to Trendy SMM?' : 'Already have an account?';
        document.querySelector('.switch-link').innerText = isLogin ? 'Create an Account' : 'Login Here';

        // Show/Hide Fields
        const signupFields = document.querySelectorAll('.signup-fields');
        signupFields.forEach(el => el.style.display = isLogin ? 'none' : 'block');
    }

    document.getElementById('authForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const u = document.getElementById('auth-username').value.trim().toLowerCase();
        const p = document.getElementById('auth-password').value;
        const btn = document.getElementById('auth-btn');

        if(!u || !p) return alert("Please fill required fields");

        btn.innerText = "Processing..."; btn.disabled = true;

        if(isLogin) {
            // LOGIN LOGIC
            db.ref('users').orderByChild('username').equalTo(u).once('value', snap => {
                let found = false;
                if(snap.exists()) {
                    snap.forEach(c => { 
                        if(c.val().password === p) {
                            found = true;
                            localStorage.setItem('smm_user', JSON.stringify({ key: c.key, ...c.val() }));
                            location.reload();
                        }
                    });
                }
                if(!found) { alert('Invalid Username or Password'); btn.innerText = "SECURE LOGIN"; btn.disabled = false; }
            });
        } else {
            // SIGNUP LOGIC
            const fullName = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const mobile = document.getElementById('reg-mobile').value;
            const confirmPass = document.getElementById('reg-confirm-pass').value;

            if(!fullName || !email || !mobile) {
                alert("Please fill all details!");
                btn.innerText = "REGISTER NOW"; btn.disabled = false; return;
            }
            if(p !== confirmPass) {
                alert("Passwords do not match!");
                btn.innerText = "REGISTER NOW"; btn.disabled = false; return;
            }

            // Check if user exists
            db.ref('users').orderByChild('username').equalTo(u).once('value', snap => {
                if(snap.exists()) { 
                    alert('Username already taken'); 
                    btn.innerText = "REGISTER NOW"; btn.disabled = false;
                } else {
                    const ref = db.ref('users').push();
                    const newUser = { 
                        username: u, 
                        password: p, 
                        fullName: fullName,
                        email: email,
                        mobile: mobile,
                        coins: 0, 
                        createdAt: Date.now() 
                    };
                    ref.set(newUser);
                    localStorage.setItem('smm_user', JSON.stringify({ key: ref.key, ...newUser }));
                    location.reload();
                }
            });
        }
    });

    function logout() { localStorage.removeItem('smm_user'); location.reload(); }

    // --- DASHBOARD DATA ---
    function initData() {
        // Balance
        db.ref(`users/${currentUser.key}/coins`).on('value', s => {
            const bal = (s.val() || 0).toFixed(2);
            // Update both desktop and mobile views
            document.getElementById('nav-balance').innerText = bal;
            document.getElementById('mob-balance').innerText = bal;
            document.getElementById('my-balance').innerText = '‚Çπ' + bal;
        });

        // Global Orders (Fake + Real)
        Promise.all([
            db.ref('settings/fakeCount').once('value'),
            db.ref('orders').once('value')
        ]).then(results => {
            const base = parseInt(results[0].val() || 0);
            
            db.ref('orders').on('value', snap => {
                const total = base + snap.numChildren();
                document.getElementById('global-orders').innerText = total.toLocaleString();
            });
        });

        // QR Code
        db.ref('settings/qrCodeUrl').on('value', s => {
            if(s.val()) { 
                document.getElementById('qr-image').src = s.val(); 
                document.getElementById('qr-image').style.display='block'; 
            }
        });

        // Services
        db.ref('services').on('value', s => {
            const data = s.val();
            if(!data) return;
            services = Object.keys(data).map(k => ({id:k, ...data[k]}));
            const cats = [...new Set(services.map(s=>s.category))];
            const sel = document.getElementById('categorySelect');
            sel.innerHTML = '<option value="">Select Category</option>';
            cats.forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
        });

        // --- NEW: FETCH ORDERS & STORE FOR LEDGER ---
        db.ref('orders').orderByChild('userId').equalTo(currentUser.key).on('value', s => {
            const list = document.getElementById('history-table');
            list.innerHTML = '';
            myOrders = []; // Reset for Ledger
            
            if(s.exists()){
                s.forEach(c => {
                    let obj = c.val();
                    obj.key = c.key;
                    myOrders.push(obj);
                });
            }

            myOrders.reverse(); // Newest first
            let count = 0;
            
            myOrders.forEach(o => {
                count++;
                let st = 'st-' + o.status.toLowerCase();
                // We stringify the object to pass it to the modal safely
                let safeObj = JSON.stringify(o).replace(/"/g, '&quot;');
                
                list.innerHTML += `
                    <tr>
                        <td class="clickable-id" onclick="openOrderModal(${safeObj})">#${o.key.substr(-4)}</td>
                        <td style="font-size:12px;">${o.serviceName}</td>
                        <td style="max-width:100px; overflow:hidden; text-overflow:ellipsis; font-size:12px; color:#888;">${o.link}</td>
                        <td>${o.quantity}</td>
                        <td><span class="badge ${st}">${o.status}</span></td>
                    </tr>`;
            });
            document.getElementById('my-orders').innerText = count;
            
            // Update Ledger whenever orders change
            updateWalletHistory();
        });

        // --- NEW: FETCH PAYMENTS & STORE FOR LEDGER ---
        db.ref('payments').orderByChild('userId').equalTo(currentUser.key).on('value', s => {
            myDeposits = []; // Reset
            if(s.exists()){
                s.forEach(c => myDeposits.push(c.val()));
            }
            // Update Ledger whenever payments change
            updateWalletHistory();
        });
    }

    // --- FEATURE 2: WALLET HISTORY LOGIC ---
    function updateWalletHistory() {
        const container = document.getElementById('wallet-history');
        container.innerHTML = '';

        // Merge Arrays
        // 1. Map Orders to Ledger Format
        const debitItems = myOrders.map(o => ({
            type: 'debit',
            amount: o.price,
            date: o.timestamp,
            title: `Order #${o.key.substr(-4)}`,
            status: 'Deducted'
        }));

        // 2. Map Deposits to Ledger Format
        const creditItems = myDeposits.map(p => ({
            type: 'credit',
            amount: p.amount,
            date: p.date,
            title: `Deposit (${p.txnId})`,
            status: p.status
        }));

        // 3. Combine and Sort by Date (Newest First)
        const allTxns = [...debitItems, ...creditItems].sort((a, b) => b.date - a.date);

        if(allTxns.length === 0) {
            container.innerHTML = '<div style="color:#666; text-align:center; padding:10px;">No transactions yet.</div>';
            return;
        }

        // 4. Render
        allTxns.forEach(tx => {
            const isCredit = tx.type === 'credit';
            const colorClass = isCredit ? 'tx-credit' : 'tx-debit';
            const sign = isCredit ? '+' : '-';
            
            // Format Date
            const d = new Date(tx.date);
            const dateStr = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            container.innerHTML += `
                <div class="tx-item">
                    <div class="tx-left">
                        <span style="font-weight:600; color:white;">${tx.title}</span>
                        <span class="tx-date">${dateStr}</span>
                    </div>
                    <div style="text-align:right;">
                        <div class="tx-amount ${colorClass}">${sign}‚Çπ${tx.amount}</div>
                        <div style="font-size:10px; color:${isCredit && tx.status!=='Completed' ? 'orange' : '#666'}">${tx.status}</div>
                    </div>
                </div>
            `;
        });
    }

    // --- FEATURE 1: MODAL LOGIC ---
    function openOrderModal(order) {
        const modal = document.getElementById('orderModal');
        modal.style.display = "block";

        // Fill Details
        document.getElementById('m-order-id').innerText = '#' + order.key.substr(-4);
        document.getElementById('m-service-name').innerText = order.serviceName;
        document.getElementById('m-link').innerText = order.link;
        document.getElementById('m-qty').innerText = order.quantity;
        document.getElementById('m-price').innerText = order.price.toFixed(2);
        
        // Advanced Placeholders (If you add these to DB later, map them here)
        document.getElementById('m-start').innerText = order.start_count || "0";
        document.getElementById('m-remains').innerText = order.remains || order.quantity;

        // Timeline Logic
        const steps = ['pending', 'processing', 'completed'];
        steps.forEach(s => document.getElementById('step-'+s).classList.remove('active'));

        if(order.status === 'Pending') {
            document.getElementById('step-pending').classList.add('active');
        } else if (order.status === 'Processing') {
            document.getElementById('step-pending').classList.add('active');
            document.getElementById('step-processing').classList.add('active');
        } else if (order.status === 'Completed') {
            steps.forEach(s => document.getElementById('step-'+s).classList.add('active'));
        } else if (order.status === 'Canceled') {
            // Visual feedback for Canceled
            steps.forEach(s => document.getElementById('step-'+s).classList.remove('active'));
            document.getElementById('step-pending').querySelector('.tl-text').innerText = "Canceled";
            document.getElementById('step-pending').querySelector('.tl-dot').style.borderColor = "#ef4444";
            document.getElementById('step-pending').querySelector('.tl-dot').style.color = "#ef4444";
        }
    }

    function closeOrderModal() {
        document.getElementById('orderModal').style.display = "none";
        // Reset canceled state visual if needed
        document.getElementById('step-pending').querySelector('.tl-text').innerText = "Pending";
        document.getElementById('step-pending').querySelector('.tl-dot').style.borderColor = "";
        document.getElementById('step-pending').querySelector('.tl-dot').style.color = "";
    }

    // Close modal if clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('orderModal');
        if (event.target == modal) {
            closeOrderModal();
        }
    }

    // --- CALCULATIONS ---
    function filterServices() {
        const cat = document.getElementById('categorySelect').value;
        const svc = document.getElementById('serviceSelect');
        svc.innerHTML = '<option value="">Select Service</option>';
        services.filter(s => s.category === cat).forEach(s => {
            svc.innerHTML += `<option value="${s.id}" data-rate="${s.price}" data-min="${s.min}" data-max="${s.max}">${s.name}</option>`;
        });
        document.getElementById('service-info').style.display = 'none';
    }

    function updateServiceInfo() {
        const sel = document.getElementById('serviceSelect');
        const opt = sel.options[sel.selectedIndex];
        if(!opt.value) return;
        document.getElementById('service-info').style.display = 'block';
        document.getElementById('svc-min').innerText = opt.dataset.min;
        document.getElementById('svc-max').innerText = opt.dataset.max;
        document.getElementById('svc-rate').innerText = opt.dataset.rate;
        calculatePrice();
    }

    function calculatePrice() {
        const qty = document.getElementById('quantity').value;
        const sel = document.getElementById('serviceSelect');
        const rate = sel.options[sel.selectedIndex]?.dataset.rate || 0;
        document.getElementById('total-charge').innerText = ((rate * qty)/1000).toFixed(2);
    }

    // --- SUBMISSIONS ---
    document.getElementById('orderForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const sel = document.getElementById('serviceSelect');
        const opt = sel.options[sel.selectedIndex];
        const qty = parseInt(document.getElementById('quantity').value);
        const link = document.getElementById('link').value;
        const price = parseFloat(document.getElementById('total-charge').innerText);

        if(!opt.value || !qty || !link) return alert("Fill all details");
        if(qty < parseInt(opt.dataset.min) || qty > parseInt(opt.dataset.max)) return alert("Invalid Quantity");

        db.ref(`users/${currentUser.key}/coins`).transaction(curr => {
            if(curr >= price) return curr - price;
            return; 
        }, (err, committed, snap) => {
            if(!committed) return alert("Insufficient Balance! Please add funds.");
            
            db.ref('orders').push({
                userId: currentUser.key,
                serviceId: opt.value,
                serviceName: opt.text,
                link: link,
                quantity: qty,
                price: price,
                status: 'Pending',
                timestamp: Date.now()
            });
            alert("Order Placed Successfully! üöÄ");
            e.target.reset();
            document.getElementById('total-charge').innerText = "0.00";
        });
    });

    document.getElementById('depositForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const amt = parseFloat(document.getElementById('dep-amount').value);
        const txn = document.getElementById('dep-txn').value.trim();

        if(!amt || !txn) return alert("Enter Amount and Txn ID");

        db.ref('payments').push({
            userId: currentUser.key,
            username: currentUser.username,
            amount: amt,
            txnId: txn,
            status: 'Pending',
            date: Date.now()
        });
        alert("Payment Request Submitted! Balance will update after admin approval.");
        e.target.reset();
    });

    checkAuth();
</script>
</body>
</html>